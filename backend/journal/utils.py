# journal/utils.py

import requests
from django.conf import settings
import logging

logger = logging.getLogger(__name__)

class AIForthaiSentimentAnalyzer:
    """
    Class à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸à¸±à¸š AIforthai Sentiment Analysis API
    """
    
    def __init__(self):
        self.api_key = settings.AIFORTHAI_API_KEY
        self.url = settings.AIFORTHAI_SENTIMENT_URL
    
    def analyze(self, text):
        """
        à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸­à¸²à¸£à¸¡à¸“à¹Œà¸ˆà¸²à¸à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡
        """
        try:
            headers = {
                'Apikey': self.api_key,  # à¸ªà¹ˆà¸‡ API key
            }
            
            data = {
                'text': text  # à¸ªà¹ˆà¸‡à¹€à¸›à¹‡à¸™ form data
            }
            
            # à¹ƒà¸Šà¹‰ data= à¹à¸—à¸™ json= à¹€à¸žà¸·à¹ˆà¸­à¸ªà¹ˆà¸‡à¹à¸šà¸š form-urlencoded
            response = requests.post(self.url, data=data, headers=headers, timeout=10)
            
            if response.status_code == 200:
                result = response.json()
                return self._parse_response(result)
            else:
                logger.error(f"AIforthai API error: {response.status_code}, {response.text}")
                return self._get_default_response()
                
        except Exception as e:
            logger.error(f"Error analyzing sentiment: {str(e)}")
            return self._get_default_response()
    
    def _parse_response(self, response):
        try:
            sentiment = response.get('sentiment', {})
            polarity = sentiment.get('polarity', 0)
            
            # à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™ string à¹€à¸Šà¹ˆà¸™ "positive"/"negative"/"neutral"
            if isinstance(polarity, str):
                polarity_str = polarity.lower()
                if polarity_str == 'positive':
                    polarity_val = 1.0
                    label = 'positive'
                elif polarity_str == 'negative':
                    polarity_val = -1.0
                    label = 'negative'
                else:
                    polarity_val = 0.0
                    label = 'neutral'
            else:
                polarity_val = float(polarity)
                if polarity_val > 0.1:
                    label = 'positive'
                elif polarity_val < -0.1:
                    label = 'negative'
                else:
                    label = 'neutral'
            
            return {
                'sentiment_score': polarity_val,
                'sentiment_label': label,
                'confidence': abs(polarity_val),
                'raw_response': response
            }
        except Exception as e:
            logger.error(f"Error parsing AIforthai response: {str(e)}")
            return self._get_default_response()

    def _get_default_response(self):
        """
        Response à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸à¸£à¸“à¸µà¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”
        """
        return {
            'sentiment_score': 0.0,
            'sentiment_label': 'neutral',
            'confidence': 0.0,
            'raw_response': None
        }
    
    
def generate_mood_suggestion(sentiment_label, sentiment_score):
    """
    à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸³à¹à¸™à¸°à¸™à¸³à¸•à¸²à¸¡à¸­à¸²à¸£à¸¡à¸“à¹Œ
    
    Args:
        sentiment_label (str): à¸›à¸£à¸°à¹€à¸ à¸—à¸­à¸²à¸£à¸¡à¸“à¹Œ (positive/neutral/negative)
        sentiment_score (float): à¸„à¸°à¹à¸™à¸™à¸­à¸²à¸£à¸¡à¸“à¹Œ
    
    Returns:
        str: à¸„à¸³à¹à¸™à¸°à¸™à¸³
    """
    suggestions = {
        'positive': [
            "à¸§à¸±à¸™à¸™à¸µà¹‰à¸„à¸¸à¸“à¸”à¸¹à¸¡à¸µà¸„à¸§à¸²à¸¡à¸ªà¸¸à¸‚à¸”à¸µà¹€à¸¥à¸¢à¸™à¸°! à¸£à¸±à¸à¸©à¸²à¸­à¸²à¸£à¸¡à¸“à¹Œà¸”à¸µà¹† à¹à¸šà¸šà¸™à¸µà¹‰à¹„à¸§à¹‰à¸™à¸° à¸­à¸¢à¹ˆà¸²à¸¥à¸·à¸¡à¹à¸šà¹ˆà¸‡à¸›à¸±à¸™à¸„à¸§à¸²à¸¡à¸ªà¸¸à¸‚à¹ƒà¸«à¹‰à¸„à¸™à¸£à¸­à¸šà¸‚à¹‰à¸²à¸‡à¸”à¹‰à¸§à¸¢ ðŸ˜Š",
            "à¹€à¸¢à¸µà¹ˆà¸¢à¸¡à¹€à¸¥à¸¢! à¸„à¸¸à¸“à¸à¸³à¸¥à¸±à¸‡à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¸”à¸µ à¸¥à¸­à¸‡à¸šà¸±à¸™à¸—à¸¶à¸à¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²à¸”à¸µà¹† à¹à¸šà¸šà¸™à¸µà¹‰à¹„à¸§à¹‰ à¹€à¸žà¸·à¹ˆà¸­à¸ˆà¸°à¹„à¸”à¹‰à¸à¸¥à¸±à¸šà¸¡à¸²à¸­à¹ˆà¸²à¸™à¹ƒà¸™à¸§à¸±à¸™à¸—à¸µà¹ˆà¸­à¸²à¸£à¸¡à¸“à¹Œà¹„à¸¡à¹ˆà¸„à¹ˆà¸­à¸¢à¸”à¸µ",
            "à¸™à¹ˆà¸²à¸¢à¸´à¸™à¸”à¸µà¸”à¹‰à¸§à¸¢! à¸­à¸²à¸£à¸¡à¸“à¹Œà¸”à¸µà¹à¸šà¸šà¸™à¸µà¹‰à¸•à¹ˆà¸­à¹„à¸›à¸™à¸° à¸­à¸¢à¹ˆà¸²à¸¥à¸·à¸¡à¸‚à¸­à¸šà¸„à¸¸à¸“à¸•à¸±à¸§à¹€à¸­à¸‡à¸—à¸µà¹ˆà¸—à¸³à¹„à¸”à¹‰à¸”à¸µà¹ƒà¸™à¸§à¸±à¸™à¸™à¸µà¹‰",
        ],
        'neutral': [
            "à¸§à¸±à¸™à¸™à¸µà¹‰à¸”à¸¹à¹€à¸›à¹‡à¸™à¸§à¸±à¸™à¸—à¸µà¹ˆà¸›à¸à¸•à¸´à¸ªà¸šà¸²à¸¢à¹† à¸™à¸° à¸–à¹‰à¸²à¸£à¸¹à¹‰à¸ªà¸¶à¸à¸§à¹ˆà¸²à¸­à¸¢à¸²à¸à¸œà¹ˆà¸­à¸™à¸„à¸¥à¸²à¸¢ à¸¥à¸­à¸‡à¸«à¸²à¸¢à¹ƒà¸ˆà¹€à¸‚à¹‰à¸²à¸¥à¸¶à¸à¹† à¹à¸¥à¹‰à¸§à¸œà¹ˆà¸­à¸™à¸­à¸­à¸à¸Šà¹‰à¸²à¹† à¸ªà¸±à¸ 5 à¸£à¸­à¸šà¸”à¸¹à¸™à¸°",
            "à¸­à¸²à¸£à¸¡à¸“à¹Œà¸‚à¸­à¸‡à¸„à¸¸à¸“à¸§à¸±à¸™à¸™à¸µà¹‰à¸”à¸¹à¸ªà¸¡à¸”à¸¸à¸¥à¸”à¸µ à¸­à¸¢à¹ˆà¸²à¸¥à¸·à¸¡à¸”à¸¹à¹à¸¥à¸•à¸±à¸§à¹€à¸­à¸‡à¹à¸¥à¸°à¸—à¸³à¹ƒà¸™à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸Šà¸­à¸šà¸šà¹‰à¸²à¸‡à¸™à¸°",
            "à¸šà¸²à¸‡à¸—à¸µà¸à¸²à¸£à¸¡à¸µà¸§à¸±à¸™à¸—à¸µà¹ˆà¸˜à¸£à¸£à¸¡à¸”à¸²à¹† à¸à¹‡à¹€à¸›à¹‡à¸™à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸”à¸µ à¸¥à¸­à¸‡à¸«à¸²à¹€à¸§à¸¥à¸²à¸—à¸³à¸ªà¸´à¹ˆà¸‡à¹€à¸¥à¹‡à¸à¹† à¸—à¸µà¹ˆà¸—à¸³à¹ƒà¸«à¹‰à¸£à¸¹à¹‰à¸ªà¸¶à¸à¸”à¸µà¸‚à¸¶à¹‰à¸™à¸ªà¸±à¸à¸™à¸´à¸”à¸™à¸°",
        ],  
        'negative': [
            "à¸§à¸±à¸™à¸™à¸µà¹‰à¸„à¸¸à¸“à¸”à¸¹à¸­à¸²à¸£à¸¡à¸“à¹Œà¹„à¸¡à¹ˆà¸„à¹ˆà¸­à¸¢à¸”à¸µà¹€à¸¥à¸¢à¸™à¸° à¸¥à¸­à¸‡à¸«à¸²à¸¢à¹ƒà¸ˆà¹€à¸›à¹‡à¸™à¸ˆà¸±à¸‡à¸«à¸§à¸°à¸”à¸¹à¹à¸¥à¹‰à¸§à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸•à¹ˆà¸²à¸‡à¹† à¸ˆà¸°à¸”à¸µà¸‚à¸¶à¹‰à¸™ à¸«à¸²à¸¢à¹ƒà¸ˆà¹€à¸‚à¹‰à¸² 4 à¸§à¸´à¸™à¸²à¸—à¸µ à¸à¸¥à¸±à¹‰à¸™ 4 à¸§à¸´à¸™à¸²à¸—à¸µ à¸«à¸²à¸¢à¹ƒà¸ˆà¸­à¸­à¸ 4 à¸§à¸´à¸™à¸²à¸—à¸µ",
            "à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸™à¸°à¸§à¹ˆà¸²à¸šà¸²à¸‡à¸§à¸±à¸™à¸¡à¸±à¸™à¸à¹‡à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸§à¸±à¸™à¸—à¸µà¹ˆà¸”à¸µ à¹à¸•à¹ˆà¸ˆà¸³à¹„à¸§à¹‰à¸™à¸°à¸§à¹ˆà¸² à¸­à¸²à¸£à¸¡à¸“à¹Œà¹à¸šà¸šà¸™à¸µà¹‰à¸¡à¸±à¸™à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸­à¸¢à¸¹à¹ˆà¸•à¸¥à¸­à¸”à¹„à¸› à¸žà¸£à¸¸à¹ˆà¸‡à¸™à¸µà¹‰à¸­à¸²à¸ˆà¸ˆà¸°à¸”à¸µà¸‚à¸¶à¹‰à¸™à¸à¹‡à¹„à¸”à¹‰",
            "à¸–à¹‰à¸²à¸£à¸¹à¹‰à¸ªà¸¶à¸à¸«à¸™à¸±à¸à¹ƒà¸ˆ à¸¥à¸­à¸‡à¸„à¸¸à¸¢à¸à¸±à¸šà¸„à¸™à¸—à¸µà¹ˆà¹„à¸§à¹‰à¹ƒà¸ˆà¹„à¸”à¹‰ à¸«à¸£à¸·à¸­à¹€à¸‚à¸µà¸¢à¸™à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¸ªà¸¶à¸à¸­à¸­à¸à¸¡à¸²à¹ƒà¸«à¹‰à¸¡à¸²à¸à¸‚à¸¶à¹‰à¸™ à¸šà¸²à¸‡à¸—à¸µà¸à¸²à¸£à¸£à¸°à¸šà¸²à¸¢à¸­à¸­à¸à¸¡à¸²à¸à¹‡à¸Šà¹ˆà¸§à¸¢à¹„à¸”à¹‰à¸™à¸°",
            "à¸­à¸¢à¹ˆà¸²à¸¥à¸·à¸¡à¸§à¹ˆà¸²à¸„à¸¸à¸“à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸­à¸¢à¸¹à¹ˆà¸„à¸™à¹€à¸”à¸µà¸¢à¸§ à¸–à¹‰à¸²à¸£à¸¹à¹‰à¸ªà¸¶à¸à¸«à¸™à¸±à¸à¸¡à¸²à¸à¹† à¸­à¸¢à¹ˆà¸²à¸¥à¸±à¸‡à¹€à¸¥à¸—à¸µà¹ˆà¸ˆà¸°à¸‚à¸­à¸„à¸§à¸²à¸¡à¸Šà¹ˆà¸§à¸¢à¹€à¸«à¸¥à¸·à¸­à¸ˆà¸²à¸à¸¡à¸·à¸­à¸­à¸²à¸Šà¸µà¸žà¸™à¸°",
        ]
    }
    
    import random
    return random.choice(suggestions.get(sentiment_label, suggestions['neutral']))