<!-- frontend/templates/journal_entry.html -->
{% extends 'base.html' %}

{% block title %}เขียน Journal - Mood Journal{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center mt-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body p-5">
                    <h3 class="card-title mb-4 fw-bold">
                        <i class="fas fa-pen-fancy text-primary"></i> เขียนบันทึกความรู้สึก
                    </h3>
                    
                    <div id="alertDiv"></div>
                    
                    <form id="journalForm">
                        <div class="mb-3">
                            <label class="form-label">หัวเรื่อง</label>
                            <input type="text" class="form-control" id="title" placeholder="เช่น วันนี้เป็นวันที่ดี...">
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label">เขียน Brain Dump ของคุณ *</label>
                            <textarea class="form-control" id="content" rows="10" 
                                placeholder="เขียนทุกอย่างที่คุณคิด รู้สึก หรืออยากระบาย... ไม่ต้องกังวลเรื่องไวยากรณ์ แค่เขียนออกมาให้หมด" 
                                required></textarea>
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> ระบบจะวิเคราะห์อารมณ์จากข้อความของคุณโดยอัตโนมัติ
                            </small>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary flex-grow-1" id="submitBtn">
                                <i class="fas fa-save"></i> บันทึกและวิเคราะห์
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='/dashboard/'">
                                <i class="fas fa-times"></i> ยกเลิก
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- แสดงผลการวิเคราะห์ -->
            <div id="analysisResult" class="mt-4" style="display: none;">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title fw-bold mb-3">
                            <i class="fas fa-chart-pie text-primary"></i> ผลการวิเคราะห์อารมณ์
                        </h5>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="text-center p-4 border rounded">
                                    <h6 class="text-muted mb-2">อารมณ์ของคุณ</h6>
                                    <div id="sentimentDisplay" class="display-4"></div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="text-center p-4 border rounded">
                                    <h6 class="text-muted mb-2">คะแนน</h6>
                                    <div id="scoreDisplay" class="display-4"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3" id="suggestionDisplay"></div>
                        
                        <div class="text-center mt-3">
                            <a href="/dashboard/" class="btn btn-primary">
                                <i class="fas fa-chart-line"></i> ดู Dashboard
                            </a>
                            <button onclick="location.reload()" class="btn btn-outline-primary">
                                <i class="fas fa-plus"></i> เขียนบันทึกใหม่
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('journalForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/login/';
            return;
        }
        
        const alertDiv = document.getElementById('alertDiv');
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังวิเคราะห์...';
        
        const data = {
            title: document.getElementById('title').value,
            content: document.getElementById('content').value
        };
        
        try {
            const response = await fetch('/api/journal/entries/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                // ซ่อนฟอร์ม
                document.getElementById('journalForm').style.display = 'none';
                
                // แสดงผลการวิเคราะห์
                const analysisDiv = document.getElementById('analysisResult');
                analysisDiv.style.display = 'block';
                
                // แสดงอารมณ์
                const sentiment = result.sentiment;
                const sentimentDisplay = document.getElementById('sentimentDisplay');
                
                if (sentiment.sentiment_label === 'positive') {
                    sentimentDisplay.innerHTML = '<span class="text-success"><i class="fas fa-smile"></i> ดี</span>';
                } else if (sentiment.sentiment_label === 'negative') {
                    sentimentDisplay.innerHTML = '<span class="text-danger"><i class="fas fa-frown"></i> ไม่ดี</span>';
                } else {
                    sentimentDisplay.innerHTML = '<span class="text-warning"><i class="fas fa-meh"></i> ปกติ</span>';
                }
                
                // แสดงคะแนน
                document.getElementById('scoreDisplay').innerHTML = 
                    `<span class="${sentiment.sentiment_score > 0 ? 'text-success' : sentiment.sentiment_score < 0 ? 'text-danger' : 'text-warning'}">
                        ${parseFloat(sentiment.sentiment_score).toFixed(2)}
                    </span>`;
                
                // แสดงคำแนะนำ
                if (result.suggestions && result.suggestions.length > 0) {
                    document.getElementById('suggestionDisplay').innerHTML = 
                        `<i class="fas fa-lightbulb"></i> ${result.suggestions[0].suggestion}`;
                }
                
                // เลื่อนไปที่ผลลัพธ์
                analysisDiv.scrollIntoView({ behavior: 'smooth' });
                
            } else {
                alertDiv.innerHTML = `
                    <div class="alert alert-danger alert-dismissible fade show">
                        <i class="fas fa-exclamation-circle"></i> เกิดข้อผิดพลาด: ${JSON.stringify(result)}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save"></i> บันทึกและวิเคราะห์';
            }
        } catch (error) {
            alertDiv.innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show">
                    <i class="fas fa-exclamation-circle"></i> เกิดข้อผิดพลาดในการเชื่อมต่อ
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> บันทึกและวิเคราะห์';
        }
    });
</script>
{% endblock %}