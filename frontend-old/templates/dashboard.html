<!-- frontend/templates/dashboard.html -->
{% extends 'base.html' %}

{% block title %}Dashboard - Mood Journal{% endblock %}

{% block content %}
<div class="container">
    <div class="row mt-4">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-body">
                    <h4 class="card-title fw-bold mb-4 ju">
                        <i class="fas fa-chart-line text-primary"></i> สถิติอารมณ์ของคุณ
                    </h4>

                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h2 id="totalEntries">0</h2>
                                    <p class="mb-0">จำนวนบันทึกทั้งหมด</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h2 id="positiveCount">0</h2>
                                    <p class="mb-0">อารมณ์ดี</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h2 id="neutralCount">0</h2>
                                    <p class="mb-0">อารมณ์ปกติ</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-danger text-white">
                                <div class="card-body text-center">
                                    <h2 id="negativeCount">0</h2>
                                    <p class="mb-0">อารมณ์ไม่ดี</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <canvas id="sentimentPieChart"></canvas>
                        </div>
                        <div class="col-md-6 mb-4">
                            <canvas id="sentimentLineChart"></canvas>
                        </div>
                    </div>

                    </i>
                    <div class="alert alert-info" id="averageSentiment"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="card-title fw-bold mb-0">
                            <i class="fas fa-book text-primary"></i> บันทึกล่าสุด
                        </h4>
                        <a href="/journal/" class="btn btn-primary">
                            <i class="fas fa-plus"></i> เขียนบันทึกใหม่
                        </a>
                    </div>

                    <div id="entriesList"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">แก้ไขบันทึก</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="mb-3">
                        <label for="editTitle" class="form-label">ชื่อบันทึก</label>
                        <input type="text" class="form-control" id="editTitle" placeholder="ชื่อบันทึก">
                    </div>
                    <div class="mb-3">
                        <label for="editContent" class="form-label">เนื้อหา</label>
                        <textarea class="form-control" id="editContent" rows="6" placeholder="เนื้อหาบันทึก"></textarea>
                    </div>
                </form>

                <!-- แสดงผลการวิเคราะห์เหมือน journal_entry -->
                <div id="editAnalysisResult" style="display:none;" class="mt-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title fw-bold mb-3">
                                <i class="fas fa-chart-pie text-primary"></i> ผลการวิเคราะห์อารมณ์
                            </h5>

                            <div class="row text-center mb-3">
                                <div class="col-md-6 mb-3">
                                    <h6 class="text-muted mb-2">อารมณ์ของคุณ</h6>
                                    <div id="editSentimentDisplay" class="display-4"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <h6 class="text-muted mb-2">คะแนน</h6>
                                    <div id="editScoreDisplay" class="display-4"></div>
                                </div>
                            </div>

                            <div class="alert alert-info d-flex align-items-center gap-2">
                                <i class="fas fa-lightbulb"></i>
                                <div id="editSuggestionDisplay"></div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn btn-primary" onclick="saveEditEntry()">
                    บันทึกและวิเคราะห์
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let pieChart, lineChart;
    let currentEditingId = null;

    async function loadDashboard() {
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/login/';
            return;
        }

        try {
            // โหลดสถิติ
            const statsResponse = await fetch('/api/journal/statistics/?days=30', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const stats = await statsResponse.json();

            // อัพเดทตัวเลข
            document.getElementById('totalEntries').textContent = stats.total_entries;
            document.getElementById('positiveCount').textContent = stats.sentiment_distribution.positive;
            document.getElementById('neutralCount').textContent = stats.sentiment_distribution.neutral;
            document.getElementById('negativeCount').textContent = stats.sentiment_distribution.negative;

            // แสดงค่าเฉลี่ย
            let avgText = '';
            if (stats.average_sentiment > 0.2) {
                avgText = `<i class="fas fa-smile"></i> คะแนนอารมณ์เฉลี่ย: ${stats.average_sentiment.toFixed(2)} - คุณมีอารมณ์เป็นบวกโดยรวม ดีมากเลย!`;
            } else if (stats.average_sentiment < -0.2) {
                avgText = `<i class="fas fa-frown"></i> คะแนนอารมณ์เฉลี่ย: ${stats.average_sentiment.toFixed(2)} - คุณอาจกำลังผ่านช่วงเวลาที่ท้าทายอยู่ อย่าลืมดูแลตัวเองนะ`;
            } else {
                avgText = `<i class="fas fa-meh"></i> คะแนนอารมณ์เฉลี่ย: ${stats.average_sentiment.toFixed(2)} - อารมณ์ของคุณค่อนข้างสมดุล`;
            }
            document.getElementById('averageSentiment').innerHTML = avgText;

            // สร้าง Pie & Line charts
            const pieCtx = document.getElementById('sentimentPieChart').getContext('2d');
            if (pieChart) pieChart.destroy();
            pieChart = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['อารมณ์ดี', 'อารมณ์ปกติ', 'อารมณ์ไม่ดี'],
                    datasets: [{
                        data: [
                            stats.sentiment_distribution.positive,
                            stats.sentiment_distribution.neutral,
                            stats.sentiment_distribution.negative
                        ],
                        backgroundColor: ['#28a745', '#ffc107', '#dc3545']
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'การกระจายของอารมณ์' } } }
            });

            const lineCtx = document.getElementById('sentimentLineChart').getContext('2d');
            if (lineChart) lineChart.destroy();

            const dailyData = stats.daily_sentiments.reverse();
            const dates = dailyData.map(d => d.date);
            const scores = dailyData.map(d => d.sentiment_score);

            lineChart = new Chart(lineCtx, {
                type: 'line',
                data: { labels: dates, datasets: [{ label: 'คะแนนอารมณ์', data: scores, borderColor: '#667eea', backgroundColor: 'rgba(102,126,234,0.1)', tension: 0.4, fill: true }] },
                options: {
                    responsive: true,
                    scales: { y: { min: -1, max: 1, ticks: { callback: v => v > 0 ? 'ดี' : v < 0 ? 'ไม่ดี' : 'ปกติ' } } }
                }
            });

            // โหลดรายการบันทึก
            const entriesResponse = await fetch('/api/journal/entries/?page_size=5', { headers: { 'Authorization': `Bearer ${token}` } });
            const entriesData = await entriesResponse.json();
            const entries = entriesData.results || [];

            let entriesHTML = '';
            if (entries.length === 0) {
                entriesHTML = '<p class="text-muted text-center py-4">ยังไม่มีบันทึก เริ่มต้นเขียนบันทึกแรกของคุณเลย!</p>';
            } else {
                entries.forEach(entry => {
                    const sentimentBadge = getSentimentBadge(entry.sentiment?.sentiment_label);
                    const suggestion = entry.suggestions?.[0]?.suggestion || '';

                    entriesHTML += `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title mb-0">${entry.title || 'ไม่มีหัวเรื่อง'}</h5>
                            <div class="d-flex gap-2">
                                ${sentimentBadge}
                                <button class="btn btn-sm btn-outline-primary edit-btn"
                                    data-id="${entry.id}"
                                    data-title="${entry.title || ''}"
                                    data-content="${entry.content}">
                                    <i class="fas fa-edit"></i> แก้ไข
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteEntry(${entry.id})">
                                    <i class="fas fa-trash"></i> ลบ
                                </button>
                            </div>
                        </div>
                        <p class="card-text text-muted small mb-2">
                            <i class="fas fa-calendar"></i> ${new Date(entry.created_at).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
                        </p>
                        <p class="card-text">${entry.content.substring(0, 150)}${entry.content.length > 150 ? '...' : ''}</p>
                        ${suggestion ? `<div class="alert alert-light mb-0"><small><i class="fas fa-lightbulb text-warning"></i> ${suggestion}</small></div>` : ''}
                    </div>
                </div>`;
                });
            }

            document.getElementById('entriesList').innerHTML = entriesHTML;

            // เพิ่ม EventListener ให้ปุ่มแก้ไข
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const b = e.currentTarget;
                    openEditModal(b.dataset.id, b.dataset.title, b.dataset.content);
                });
            });

        } catch (err) {
            console.error(err);
            localStorage.removeItem('access_token');
            window.location.href = '/login/';
        }
    }

    function getSentimentBadge(sentiment) {
        const badges = {
            'positive': '<span class="badge bg-success d-inline-flex align-items-center gap-1"><i class="fas fa-smile"></i> ดี</span>',
            'neutral': '<span class="badge bg-warning d-inline-flex align-items-center gap-1"><i class="fas fa-meh"></i> ปกติ</span>',
            'negative': '<span class="badge bg-danger d-inline-flex align-items-center gap-1"><i class="fas fa-frown"></i> ไม่ดี</span>'
        };
        return badges[sentiment] || '';
    }

    function openEditModal(entryId, title, content) {
        currentEditingId = entryId;
        document.getElementById('editTitle').value = title;
        document.getElementById('editContent').value = content;
        document.getElementById('editAnalysisResult').style.display = 'none';
        new bootstrap.Modal(document.getElementById('editModal')).show();
    }

    async function saveEditEntry() {
        const token = localStorage.getItem('access_token');
        const title = document.getElementById('editTitle').value;
        const content = document.getElementById('editContent').value;
        if (!title || !content) { alert('กรุณากรอกข้อมูลให้ครบถ้วน'); return; }
        try {
            const res = await fetch(`/api/journal/entries/${currentEditingId}/`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, content })
            });
            const result = await res.json();
            if (res.ok) {
                const sentiment = result.sentiment;
                document.getElementById('editSentimentDisplay').innerHTML = sentiment.sentiment_label === 'positive' ? '<span class="text-success"><i class="fas fa-smile"></i> ดี</span>' : sentiment.sentiment_label === 'negative' ? '<span class="text-danger"><i class="fas fa-frown"></i> ไม่ดี</span>' : '<span class="text-warning"><i class="fas fa-meh"></i> ปกติ</span>';
                document.getElementById('editScoreDisplay').innerHTML = `<span class="${sentiment.sentiment_score > 0 ? 'text-success' : sentiment.sentiment_score < 0 ? 'text-danger' : 'text-warning'}">${parseFloat(sentiment.sentiment_score).toFixed(2)}</span>`;
                document.getElementById('editSuggestionDisplay').innerHTML = result.suggestions?.[0]?.suggestion || '';
                document.getElementById('editAnalysisResult').style.display = 'block';
                loadDashboard();
            } else { alert('เกิดข้อผิดพลาด'); }
        } catch (err) { console.error(err); alert('เกิดข้อผิดพลาด'); }
    }

    async function deleteEntry(entryId) {
        if (!confirm('คุณแน่ใจว่าต้องการลบบันทึกนี้?')) return;
        const token = localStorage.getItem('access_token');
        try {
            const res = await fetch(`/api/journal/entries/${entryId}/`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
            if (res.ok || res.status === 204) { alert('ลบบันทึกสำเร็จ'); loadDashboard(); } else { alert('เกิดข้อผิดพลาด'); }
        } catch (err) { console.error(err); alert('เกิดข้อผิดพลาด'); }
    }

    loadDashboard();
</script>
{% endblock %}