{% extends 'base.html' %}

{% block title %}แก้ไขโปรไฟล์ - Mood Journal{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div id="alertDiv"></div>
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title fw-bold mb-4">
                        <i class="fas fa-user-edit text-primary"></i> แก้ไขโปรไฟล์ของคุณ
                    </h3>
                    <form id="profileForm">
                        <div class="mb-3">
                            <label class="form-label">ชื่อ</label>
                            <input type="text" class="form-control" id="first_name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">นามสกุล</label>
                            <input type="text" class="form-control" id="last_name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">อีเมล</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">รหัสผ่านใหม่ (เว้นว่างถ้าไม่เปลี่ยน)</label>
                            <input type="password" class="form-control" id="password">
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-save"></i> บันทึก
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/login/';
        return;
    }

    const alertDiv = document.getElementById('alertDiv');
    const form = document.getElementById('profileForm');

    // โหลดข้อมูลผู้ใช้จาก API
    try {
        const response = await fetch('/api/accounts/profile/', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        document.getElementById('first_name').value = data.first_name || '';
        document.getElementById('last_name').value = data.last_name || '';
        document.getElementById('email').value = data.email || '';
    } catch (err) {
        console.error(err);
        alertDiv.innerHTML = `<div class="alert alert-danger">ไม่สามารถโหลดข้อมูลผู้ใช้ได้</div>`;
    }

    // submit form -> PUT API
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            const bodyData = {
                first_name: document.getElementById('first_name').value,
                last_name: document.getElementById('last_name').value,
                email: document.getElementById('email').value
            };

            const password = document.getElementById('password').value;
            if (password) bodyData.password = password; // ส่ง password เฉพาะถ้าใส่

            const response = await fetch('/api/accounts/profile/', {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(bodyData)
            });

            if (response.ok) {
                alertDiv.innerHTML = `<div class="alert alert-success">บันทึกสำเร็จ!</div>`;
                document.getElementById('password').value = ''; // ล้างรหัสผ่าน
            } else {
                const errData = await response.json();
                alertDiv.innerHTML = `<div class="alert alert-danger">${JSON.stringify(errData)}</div>`;
            }
        } catch (err) {
            alertDiv.innerHTML = `<div class="alert alert-danger">เกิดข้อผิดพลาดในการเชื่อมต่อ</div>`;
        }
    });
});
</script>
{% endblock %}
